// Lấy tham số từ URL
// Xử lý trường hợp URL có nhiều query string (ví dụ: ?mode=screen?id=CONN-1)
let searchString = window.location.search;
// Nếu có nhiều dấu ?, chỉ lấy phần đầu tiên
if (searchString.split('?').length > 2) {
    // Tách URL và chỉ lấy phần query string đầu tiên
    const urlParts = window.location.href.split('?');
    if (urlParts.length > 1) {
        // Lấy phần query string đầu tiên (sau dấu ? đầu tiên)
        searchString = '?' + urlParts[1];
    }
}

const urlParams = new URLSearchParams(searchString);
let mode = urlParams.get('mode'); // "screen" hoặc "webcam"

// Nếu mode vẫn không hợp lệ, thử parse từ URL trực tiếp
if (!mode || (mode !== 'screen' && mode !== 'webcam')) {
    // Thử tìm mode trong URL bằng regex
    const modeMatch = window.location.href.match(/[?&]mode=([^&?]+)/);
    if (modeMatch && modeMatch[1]) {
        mode = modeMatch[1].split('?')[0].split('&')[0]; // Lấy phần đầu, bỏ qua các tham số sau
    }
}

// Log để debug
console.log('[Screen_Webcam] Mode:', mode);
console.log('[Screen_Webcam] URL:', window.location.href);
console.log('[Screen_Webcam] Search:', searchString);

// ===============================================
// 1. LOGIC CHỌN THƯ MỤC
// ===============================================

function triggerSelectFolder() {
    const hiddenInput = document.getElementById('hidden-folder-input');
    hiddenInput.click();
}

function onFolderSelected(input) {
    if (input.files && input.files.length > 0) {

        const relativePath = input.files[0].webkitRelativePath;
        
        const folderName = relativePath.split('/')[0];

        const folderLabel = document.getElementById('display-folder-path');
        
        folderLabel.innerText = `D:/User/Projects/${folderName}/`;
        
        input.value = ''; 
    }
}

// ===============================================
// 2. LOGIC LƯU FILE (NÚT SAVE TO DEVICE)
// ===============================================

function handleSaveAction() {
    const cameraFeed = document.getElementById('camera-feed');
    const img = cameraFeed.querySelector('img');
    const video = cameraFeed.querySelector('video');
    
    if (!img && !video) {
        alert('No preview available to save');
        return;
    }

    const folderPath = document.getElementById('display-folder-path').innerText;
    let fileName = document.getElementById('input-file-name').value;
    
    if (!fileName || fileName.trim() === "") {
        fileName = img ? "capture_default.png" : "capture_default.mp4";
        document.getElementById('input-file-name').value = fileName;
    }

    const fullPath = folderPath + fileName;

    if (img) {
        const link = document.createElement('a');
        link.href = img.src;
        link.download = fileName;
        link.click();
    } else if (video) {
        const link = document.createElement('a');
        link.href = video.src;
        link.download = fileName;
        link.click();
    }

    console.log("Saving to:", fullPath);
}

function capture() {
    try {
        // Kiểm tra gateway đã sẵn sàng chưa
        if (!window.gateway) {
            console.error('[Capture] Gateway chưa sẵn sàng');
            alert('Gateway chưa sẵn sàng. Vui lòng đợi kết nối...');
            return;
        }
        
        if (!window.CONFIG || !window.CONFIG.CMD) {
            console.error('[Capture] CONFIG chưa sẵn sàng');
            alert('CONFIG chưa sẵn sàng. Vui lòng đợi...');
            return;
        }

        // Kiểm tra mode
        if (!mode) {
            console.error('[Capture] Mode không được xác định');
            alert('Mode không hợp lệ. Vui lòng kiểm tra URL (cần có ?mode=screen hoặc ?mode=webcam)');
            return;
        }

        if (mode === 'screen') {
            // Gửi lệnh chụp màn hình
            console.log('[Capture] Sending SCREENSHOT command');
            window.gateway.send(window.CONFIG.CMD.SCREENSHOT, "");
            // Cập nhật tên file mặc định cho ảnh
            document.getElementById('input-file-name').value = 'screenshot_' + Date.now() + '.png';
        } else if (mode === 'webcam') {
            // Gửi lệnh chụp webcam
            console.log('[Capture] Sending CAMSHOT command');
            window.gateway.send(window.CONFIG.CMD.CAMSHOT, "");
            // Cập nhật tên file mặc định cho ảnh
            document.getElementById('input-file-name').value = 'webcam_' + Date.now() + '.png';
        } else {
            console.error('[Capture] Mode không hợp lệ:', mode);
            alert('Mode không hợp lệ: ' + mode);
        }
    } catch (error) {
        console.error('[Capture] Error:', error);
        alert('Lỗi khi capture: ' + error.message);
    }
}

function record() {
    try {
        // Kiểm tra gateway đã sẵn sàng chưa
        if (!window.gateway) {
            console.error('[Record] Gateway chưa sẵn sàng');
            alert('Gateway chưa sẵn sàng. Vui lòng đợi kết nối...');
            return;
        }
        
        if (!window.CONFIG || !window.CONFIG.CMD) {
            console.error('[Record] CONFIG chưa sẵn sàng');
            alert('CONFIG chưa sẵn sàng. Vui lòng đợi...');
            return;
        }

        // Kiểm tra mode
        if (!mode) {
            console.error('[Record] Mode không được xác định');
            alert('Mode không hợp lệ. Vui lòng kiểm tra URL (cần có ?mode=screen hoặc ?mode=webcam)');
            return;
        }

        // Lấy phần tử input có class 'duration-input'
        const durationInput = document.querySelector('.duration-input');
        if (!durationInput) {
            console.error('[Record] Không tìm thấy duration-input');
            alert('Không tìm thấy input thời gian');
            return;
        }

        // Lấy giá trị hiện tại (là chuỗi)
        const value = durationInput.value;

        // Chuyển đổi sang số và kiểm tra hợp lệ
        const duration = parseInt(value, 10);
        if (isNaN(duration) || duration < 1) {
            alert('Vui lòng nhập thời gian hợp lệ (>= 1 giây)');
            return;
        }

        // Giới hạn thời gian tối đa 15 giây (theo server)
        const finalDuration = Math.min(duration, 15);

        if (mode === 'screen') {
            // Gửi lệnh quay màn hình với thời gian
            console.log('[Record] Sending SCR_RECORD command with duration:', finalDuration);
            window.gateway.send(window.CONFIG.CMD.SCR_RECORD, String(finalDuration));
            // Cập nhật tên file mặc định cho video
            document.getElementById('input-file-name').value = 'screen_record_' + Date.now() + '.mp4';
        } else if (mode === 'webcam') {
            // Gửi lệnh quay webcam với thời gian
            console.log('[Record] Sending CAM_RECORD command with duration:', finalDuration);
            window.gateway.send(window.CONFIG.CMD.CAM_RECORD, String(finalDuration));
            // Cập nhật tên file mặc định cho video
            document.getElementById('input-file-name').value = 'webcam_record_' + Date.now() + '.mp4';
        } else {
            console.error('[Record] Mode không hợp lệ:', mode);
            alert('Mode không hợp lệ: ' + mode);
        }
    } catch (error) {
        console.error('[Record] Error:', error);
        alert('Lỗi khi record: ' + error.message);
    }
}

// ===============================================
// 3. LOGIC HIỂN THỊ PREVIEW (ẢNH/VIDEO)
// ===============================================

// Hiển thị ảnh preview (cho screenshot và webcam shot)
window.displayImagePreview = function(base64Data) {
    const cameraFeed = document.getElementById('camera-feed');
    
    if (!cameraFeed) {
        console.error('Không tìm thấy camera-feed element');
        return;
    }

    // Xóa placeholder text nếu có
    const placeholder = cameraFeed.querySelector('.placeholder-text');
    if (placeholder) {
        placeholder.remove();
    }

    // Xóa video nếu có
    const existingVideo = cameraFeed.querySelector('video');
    if (existingVideo) {
        existingVideo.remove();
    }

    // Kiểm tra xem đã có img chưa, nếu có thì cập nhật src
    let img = cameraFeed.querySelector('img');
    if (!img) {
        img = document.createElement('img');
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        img.style.objectFit = 'contain';
        cameraFeed.appendChild(img);
    }

    img.src = "data:image/jpeg;base64," + base64Data;
    img.alt = mode === 'screen' ? 'Screen Capture' : 'Webcam Capture';
};

// Hiển thị video preview (cho screen record và webcam record)
window.displayVideoPreview = function(base64Data) {
    const cameraFeed = document.getElementById('camera-feed');
    
    if (!cameraFeed) {
        console.error('Không tìm thấy camera-feed element');
        return;
    }

    // Xóa placeholder text nếu có
    const placeholder = cameraFeed.querySelector('.placeholder-text');
    if (placeholder) {
        placeholder.remove();
    }

    // Xóa ảnh nếu có
    const existingImg = cameraFeed.querySelector('img');
    if (existingImg) {
        existingImg.remove();
    }

    // Kiểm tra xem đã có video chưa, nếu có thì cập nhật src
    let video = cameraFeed.querySelector('video');
    if (!video) {
        video = document.createElement('video');
        video.controls = true;
        video.style.maxWidth = '100%';
        video.style.maxHeight = '100%';
        video.style.objectFit = 'contain';
        cameraFeed.appendChild(video);
    }

    video.src = "data:video/mp4;base64," + base64Data;
    video.load(); // Tải lại video với src mới
};

// Xử lý lỗi khi capture/record
window.handleCaptureError = function(errorMessage) {
    console.error('[Capture Error]', errorMessage);
    
    // Xóa placeholder và hiển thị thông báo lỗi trong preview area
    const cameraFeed = document.getElementById('camera-feed');
    if (cameraFeed) {
        // Xóa các element preview cũ
        const existingImg = cameraFeed.querySelector('img');
        const existingVideo = cameraFeed.querySelector('video');
        if (existingImg) existingImg.remove();
        if (existingVideo) existingVideo.remove();
        
        // Kiểm tra xem đã có error message chưa
        let errorDiv = cameraFeed.querySelector('.error-message');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.cssText = `
                padding: 20px;
                text-align: center;
                color: #ef4444;
                background-color: #fee2e2;
                border: 2px solid #ef4444;
                border-radius: 8px;
                margin: 20px;
                font-family: 'Inter', sans-serif;
            `;
            cameraFeed.appendChild(errorDiv);
        }
        
        // Dịch thông báo lỗi sang tiếng Việt nếu cần
        let friendlyMessage = errorMessage;
        
        // Kiểm tra lỗi "cannot execute binary file" - không tương thích kiến trúc CPU
        if (errorMessage.includes('cannot execute binary file') || errorMessage.includes('cannot execute binary')) {
            friendlyMessage = '❌ Lỗi: Ffmpeg không tương thích với kiến trúc CPU\n\n' +
                            'Nguyên nhân: File ffmpeg được biên dịch cho kiến trúc CPU khác (x86_64 vs ARM64)\n\n' +
                            'Giải pháp:\n' +
                            '1. Xóa ffmpeg cũ:\n' +
                            '   rm ~/.local/bin/ffmpeg\n\n' +
                            '2. Cài đặt lại ffmpeg đúng kiến trúc:\n' +
                            '   - Với Apple Silicon (M1/M2/M3): brew install ffmpeg\n' +
                            '   - Hoặc tải từ: https://evermeet.cx/ffmpeg/\n\n' +
                            '3. Kiểm tra kiến trúc hệ thống:\n' +
                            '   uname -m  (phải là arm64 cho Apple Silicon)';
        } else if (errorMessage.includes('Ffmpeg chay xong nhung khong co du lieu anh')) {
            // Lỗi này có thể do ffmpeg không tương thích kiến trúc CPU
            friendlyMessage = 'Lỗi: Ffmpeg không thể tạo dữ liệu ảnh\n\n' +
                            'Nguyên nhân có thể:\n' +
                            '1. Ffmpeg không tương thích với kiến trúc CPU (x86_64 vs ARM64)\n' +
                            '   → Giải pháp: Xóa ffmpeg cũ và cài lại đúng kiến trúc:\n' +
                            '      rm ~/.local/bin/ffmpeg\n' +
                            '      brew install ffmpeg\n\n' +
                            '2. Màn hình không có nội dung\n' +
                            '3. Lỗi quyền truy cập màn hình\n' +
                            '4. Lỗi cấu hình Ffmpeg';
        } else if (errorMessage.includes('Ffmpeg') || errorMessage.includes('ffmpeg')) {
            friendlyMessage = 'Lỗi: ' + errorMessage + '\n\nVui lòng kiểm tra:\n- Ffmpeg đã được cài đặt đúng chưa\n- Quyền truy cập màn hình/webcam\n- Kiến trúc CPU có tương thích không (x86_64 vs ARM64)';
        }
        
        // Escape HTML để tránh XSS
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        errorDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">⚠️ Lỗi Capture</div>
            <div style="font-size: 13px; white-space: pre-line; line-height: 1.6; text-align: left; max-height: 400px; overflow-y: auto;">${escapeHtml(friendlyMessage)}</div>
        `;
        
        // Tự động xóa error message sau 10 giây
        setTimeout(() => {
            if (errorDiv && errorDiv.parentNode) {
                errorDiv.remove();
                // Khôi phục placeholder nếu không có preview nào
                if (!cameraFeed.querySelector('img') && !cameraFeed.querySelector('video')) {
                    const placeholder = document.createElement('span');
                    placeholder.className = 'placeholder-text';
                    placeholder.textContent = 'this is a preview';
                    cameraFeed.appendChild(placeholder);
                }
            }
        }, 10000);
    }
    
    // Vẫn hiển thị alert để đảm bảo người dùng nhận được thông báo
    alert('❌ Lỗi Capture\n\n' + errorMessage);
};